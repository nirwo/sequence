<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Application Monitor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .status-badge {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .status-up {
            background-color: #28a745;
        }
        .status-down {
            background-color: #dc3545;
        }
        .system-actions {
            white-space: nowrap;
        }
        .table td {
            vertical-align: middle;
        }
        .cluster-nodes {
            font-size: 0.85em;
            color: #666;
        }
        
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1060;
        }
        
        .toast {
            min-width: 300px;
            max-width: 500px;
            background-color: white;
            border-left: 4px solid #dc3545;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }
        
        .toast.success {
            border-left-color: #28a745;
        }
        
        .toast.error {
            border-left-color: #dc3545;
        }
        
        .toast.info {
            border-left-color: #17a2b8;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Application Monitor</a>
            <div class="d-flex">
                <button class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#wizardModal">
                    <i class="fas fa-plus me-2"></i>Add System
                </button>
                <div class="dropdown">
                    <button class="btn btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="fas fa-file-import me-2"></i>Import
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="document.getElementById('csvFile').click()">Quick Import CSV</a></li>
                        <li><a class="dropdown-item" href="#" onclick="openCSVMapping()">Map & Import CSV</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="/example_import.csv" download>Download Example CSV</a></li>
                    </ul>
                </div>
                <input type="file" id="csvFile" accept=".csv" style="display: none" onchange="importCSV(this)">
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="systemsTable">
                        <thead>
                            <tr>
                                <th style="width: 50px">Status</th>
                                <th>System Name</th>
                                <th>Application</th>
                                <th>Type</th>
                                <th>Target</th>
                                <th>Database</th>
                                <th>Owner</th>
                                <th>Last Check</th>
                                <th style="width: 120px">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit System</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editSystemForm" onsubmit="saveEditedSystem(event)">
                        <div class="mb-3">
                            <label class="form-label">System Name</label>
                            <input type="text" class="form-control" name="name" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Application Name</label>
                            <input type="text" class="form-control" name="app_name" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Check Type</label>
                            <select class="form-select" name="check_type" required>
                                <option value="http">HTTP</option>
                                <option value="ping">Ping</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Target URL/IP</label>
                            <input type="text" class="form-control" name="target">
                            <small class="text-muted">Required for single node systems. For clusters, first node will be used if empty.</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Cluster Nodes</label>
                            <input type="text" class="form-control" name="cluster_nodes">
                            <small class="text-muted">Comma-separated list of nodes</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Database Name</label>
                            <input type="text" class="form-control" name="db_name">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Database Type</label>
                            <input type="text" class="form-control" name="db_type">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Mount Points</label>
                            <input type="text" class="form-control" name="mount_points">
                            <small class="text-muted">Comma-separated list</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Owner</label>
                            <input type="text" class="form-control" name="owner">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Shutdown Sequence</label>
                            <textarea class="form-control" name="shutdown_sequence" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" form="editSystemForm">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Wizard Modal -->
    <div class="modal fade" id="wizardModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New System</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="wizard">
                        <div class="wizard-steps mb-4">
                            <div class="progress">
                                <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                            </div>
                            <div class="d-flex justify-content-between mt-2">
                                <span class="step-indicator active">1. Application</span>
                                <span class="step-indicator">2. Server(s)</span>
                                <span class="step-indicator">3. Database</span>
                                <span class="step-indicator">4. Details</span>
                            </div>
                        </div>
                        
                        <form id="wizardForm">
                            <!-- Step 1: Application -->
                            <div class="wizard-step" data-step="1">
                                <h6>Application Information</h6>
                                <div class="mb-3">
                                    <label class="form-label">Application Name</label>
                                    <input type="text" class="form-control" name="app_name" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Application Owner</label>
                                    <input type="text" class="form-control" name="owner" required>
                                </div>
                            </div>

                            <!-- Step 2: Servers -->
                            <div class="wizard-step d-none" data-step="2">
                                <h6>Server Information</h6>
                                <div class="mb-3">
                                    <label class="form-label">Is this a cluster?</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="is_cluster" value="no" checked onchange="toggleClusterView()">
                                        <label class="form-check-label">Single Server</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="is_cluster" value="yes" onchange="toggleClusterView()">
                                        <label class="form-check-label">Cluster</label>
                                    </div>
                                </div>
                                <div id="singleServerForm">
                                    <div class="mb-3">
                                        <label class="form-label">Server Name</label>
                                        <input type="text" class="form-control" name="name" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Check Type</label>
                                        <select class="form-select" name="check_type" required>
                                            <option value="ping">Ping</option>
                                            <option value="http">HTTP</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Target (IP/URL)</label>
                                        <input type="text" class="form-control" name="target" required>
                                    </div>
                                </div>
                                <div id="clusterForm" class="d-none">
                                    <div id="clusterNodes">
                                        <div class="cluster-node mb-3">
                                            <div class="card">
                                                <div class="card-body">
                                                    <div class="mb-3">
                                                        <label class="form-label">Node Name</label>
                                                        <input type="text" class="form-control" name="cluster_nodes[]" required>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label class="form-label">Target (IP/URL)</label>
                                                        <input type="text" class="form-control" name="cluster_targets[]" required>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <button type="button" class="btn btn-secondary" onclick="addClusterNode()">
                                        <i class="fas fa-plus me-2"></i>Add Node
                                    </button>
                                </div>
                            </div>

                            <!-- Step 3: Database -->
                            <div class="wizard-step d-none" data-step="3">
                                <h6>Database Information</h6>
                                <div class="mb-3">
                                    <label class="form-label">Does this application have a database?</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="has_db" value="no" checked onchange="toggleDBView()">
                                        <label class="form-check-label">No</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="has_db" value="yes" onchange="toggleDBView()">
                                        <label class="form-check-label">Yes</label>
                                    </div>
                                </div>
                                <div id="dbForm" class="d-none">
                                    <div class="mb-3">
                                        <label class="form-label">Database Name</label>
                                        <input type="text" class="form-control" name="db_name">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Database Type</label>
                                        <input type="text" class="form-control" name="db_type">
                                    </div>
                                </div>
                            </div>

                            <!-- Step 4: Additional Details -->
                            <div class="wizard-step d-none" data-step="4">
                                <h6>Additional Details</h6>
                                <div class="mb-3">
                                    <label class="form-label">Mount Points (NFS/CIFS)</label>
                                    <input type="text" class="form-control" name="mount_points">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Shutdown Sequence</label>
                                    <textarea class="form-control" name="shutdown_sequence" rows="3"></textarea>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="previousStep()">Previous</button>
                    <button type="button" class="btn btn-primary" onclick="nextStep()">Next</button>
                </div>
            </div>
        </div>
    </div>

    <!-- CSV Mapping Modal -->
    <div class="modal fade" id="csvMappingModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Map CSV Fields</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Select CSV File</label>
                        <input type="file" class="form-control" id="csvMappingFile" accept=".csv" onchange="previewCSV(this)">
                    </div>
                    
                    <div id="csvPreview" class="d-none">
                        <h6>Preview</h6>
                        <div class="table-responsive mb-3">
                            <table class="table table-sm">
                                <thead id="csvPreviewHeader"></thead>
                                <tbody id="csvPreviewBody"></tbody>
                            </table>
                        </div>
                        
                        <h6>Field Mapping</h6>
                        <div id="fieldMapping" class="row g-3"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="importMappedCSV()">Import</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let systems = [];
        let currentStep = 1;
        const totalSteps = 4;

        // Fetch systems from the server
        function fetchSystems() {
            fetch('/api/systems')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    systems = data.systems || [];
                    updateSystemsTable();
                })
                .catch(error => {
                    showToast('Error fetching systems: ' + error.message, 'error');
                });
        }

        // Update the systems table display
        function updateSystemsTable() {
            const tbody = document.querySelector('#systemsTable tbody');
            tbody.innerHTML = '';

            if (systems.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="text-center">No systems found</td>
                    </tr>
                `;
                return;
            }

            systems.forEach(system => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <span class="status-indicator ${system.status ? 'active' : 'inactive'}"
                              title="${system.status ? 'Online' : 'Offline'}">
                        </span>
                    </td>
                    <td>${system.name || ''}</td>
                    <td>${system.app_name || ''}</td>
                    <td>${system.check_type || ''}</td>
                    <td>${system.target || ''}</td>
                    <td>${system.db_name || ''}</td>
                    <td>${system.owner || ''}</td>
                    <td>${system.last_check ? new Date(system.last_check).toLocaleString() : ''}</td>
                    <td>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-outline-primary" onclick="editSystem('${system._id}')" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteSystem('${system._id}')" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Edit system
        function editSystem(systemId) {
            const system = systems.find(s => s._id === systemId);
            if (!system) {
                showToast('System not found', 'error');
                return;
            }

            const form = document.getElementById('editSystemForm');
            form.dataset.systemId = systemId;
            
            // Set form values with null checks
            const fields = {
                'name': system.name,
                'app_name': system.app_name,
                'check_type': system.check_type,
                'target': system.target,
                'db_name': system.db_name,
                'db_type': system.db_type,
                'mount_points': system.mount_points,
                'owner': system.owner,
                'shutdown_sequence': system.shutdown_sequence,
                'cluster_nodes': system.cluster_nodes ? system.cluster_nodes.join(',') : ''
            };

            for (const [field, value] of Object.entries(fields)) {
                const element = form.querySelector(`[name="${field}"]`);
                if (element) {
                    element.value = value || '';
                }
            }

            // Show the modal
            new bootstrap.Modal(document.getElementById('editModal')).show();
        }

        // Save edited system
        function saveEditedSystem(event) {
            event.preventDefault();
            const form = document.getElementById('editSystemForm');
            const systemId = form.dataset.systemId;
            
            if (!systemId) {
                showToast('System ID not found', 'error');
                return;
            }

            const formData = {
                name: form.querySelector('[name="name"]').value.trim(),
                app_name: form.querySelector('[name="app_name"]').value.trim(),
                check_type: form.querySelector('[name="check_type"]').value,
                target: form.querySelector('[name="target"]').value.trim(),
                db_name: form.querySelector('[name="db_name"]').value.trim(),
                db_type: form.querySelector('[name="db_type"]').value.trim(),
                mount_points: form.querySelector('[name="mount_points"]').value.trim(),
                owner: form.querySelector('[name="owner"]').value.trim(),
                shutdown_sequence: form.querySelector('[name="shutdown_sequence"]').value.trim(),
                cluster_nodes: form.querySelector('[name="cluster_nodes"]').value.trim()
            };

            if (!formData.name || !formData.app_name) {
                showToast('System Name and Application Name are required', 'error');
                return;
            }

            fetch(`/api/systems/${systemId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showToast(data.error, 'error');
                } else {
                    showToast('System updated successfully', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
                    fetchSystems();
                }
            })
            .catch(error => {
                showToast('Error updating system: ' + error.message, 'error');
            });
        }

        // Delete system
        function deleteSystem(systemId) {
            if (!confirm('Are you sure you want to delete this system?')) {
                return;
            }

            fetch(`/api/systems/${systemId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showToast(data.error, 'error');
                } else {
                    showToast('System deleted successfully', 'success');
                    fetchSystems();
                }
            })
            .catch(error => {
                showToast('Error deleting system: ' + error.message, 'error');
            });
        }

        // Import CSV
        function importCSV(input) {
            if (!input.files.length) return;
            
            const formData = new FormData();
            formData.append('file', input.files[0]);
            
            fetch('/api/systems/import', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showToast(data.error, 'error');
                } else {
                    showToast(`Successfully imported ${data.systems_added} systems`, 'success');
                    if (data.warnings) {
                        data.warnings.forEach(warning => {
                            showToast(warning, 'info', 8000);
                        });
                    }
                    fetchSystems();
                }
            })
            .catch(error => {
                showToast('Error importing CSV file: ' + error.message, 'error');
            })
            .finally(() => {
                input.value = '';
            });
        }

        // Wizard navigation functions
        function nextStep() {
            if (currentStep < totalSteps) {
                currentStep++;
                showStep(currentStep);
                updateProgressBar();
            } else {
                submitWizardForm();
            }
        }

        function previousStep() {
            if (currentStep > 1) {
                currentStep--;
                showStep(currentStep);
                updateProgressBar();
            }
        }

        function showStep(step) {
            document.querySelectorAll('.wizard-step').forEach(s => {
                if (parseInt(s.dataset.step) === step) {
                    s.classList.remove('d-none');
                } else {
                    s.classList.add('d-none');
                }
            });

            const footer = document.querySelector('.modal-footer');
            const prevBtn = footer.querySelector('button:first-child');
            const nextBtn = footer.querySelector('button:last-child');

            prevBtn.style.display = step === 1 ? 'none' : 'block';
            nextBtn.textContent = step === totalSteps ? 'Submit' : 'Next';
        }

        function updateProgressBar() {
            const progress = ((currentStep - 1) / (totalSteps - 1)) * 100;
            document.querySelector('.progress-bar').style.width = `${progress}%`;
            
            document.querySelectorAll('.step-indicator').forEach((indicator, index) => {
                if (index + 1 < currentStep) {
                    indicator.classList.add('completed');
                } else if (index + 1 === currentStep) {
                    indicator.classList.add('active');
                } else {
                    indicator.classList.remove('active', 'completed');
                }
            });
        }

        // Toast notification system
        function showToast(message, type = 'info', duration = 5000) {
            const container = document.querySelector('.toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type} show`;
            toast.innerHTML = `
                <div class="toast-header">
                    <strong class="me-auto">${type.charAt(0).toUpperCase() + type.slice(1)}</strong>
                    <button type="button" class="btn-close" onclick="this.closest('.toast').remove()"></button>
                </div>
                <div class="toast-body">
                    ${message}
                </div>
            `;
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, duration);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Add form submit handler
            document.getElementById('editSystemForm').addEventListener('submit', saveEditedSystem);
            
            // Initial load
            fetchSystems();
            
            // Setup refresh interval
            setInterval(fetchSystems, 60000); // Refresh every minute
        });
    </script>
</body>
</html>
