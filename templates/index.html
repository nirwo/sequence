<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Application Monitor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-weight: bold;
            display: inline-block;
            min-width: 80px;
            text-align: center;
        }

        .status-badge.online {
            background-color: #28a745;
            color: white;
        }

        .status-badge.offline {
            background-color: #dc3545;
            color: white;
        }

        .card {
            margin-bottom: 1rem;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }

        .card-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .badge {
            font-size: 0.875rem;
            padding: 0.375rem 0.5rem;
            min-width: 40px;
        }

        .list-group-item {
            border-left: none;
            border-right: none;
        }

        .list-group-item:first-child {
            border-top: none;
        }

        .list-group-item:last-child {
            border-bottom: none;
        }

        #systemsTable th {
            background-color: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
        }

        #systemsTable td {
            vertical-align: middle;
        }

        .btn-group-sm > .btn, .btn-sm {
            padding: 0.25rem 0.5rem;
            margin: 0.125rem;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
        }

        .sequence-status {
            width: 120px;
            font-size: 0.875rem;
            padding: 0.25rem;
        }

        .cluster-nodes {
            font-size: 0.875rem;
            color: #6c757d;
            margin-top: 0.25rem;
        }

        .cluster-node {
            display: inline-block;
            margin-right: 0.5rem;
            padding: 0.125rem 0.25rem;
            border-radius: 0.25rem;
            background-color: #f8f9fa;
        }

        .error-message {
            color: #dc3545;
            font-size: 0.875rem;
        }

        .table-responsive {
            margin-bottom: 1rem;
        }
        
        .toast-container {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            z-index: 1050;
        }
        
        .toast {
            min-width: 300px;
            max-width: 500px;
            background-color: white;
            border-left: 4px solid #dc3545;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }
        
        .toast.success {
            border-left-color: #28a745;
        }
        
        .toast.error {
            border-left-color: #dc3545;
        }
        
        .toast.info {
            border-left-color: #17a2b8;
        }
        
        .status-indicator {
            display: inline-block;
            width: 20px;
            height: 20px;
            text-align: center;
            line-height: 20px;
        }

        .status-indicator i {
            font-size: 10px;
        }

        .status-indicator.active i {
            color: #28a745;
        }

        .status-indicator.inactive i {
            color: #dc3545;
        }

        .wizard-step {
            min-height: 300px;
        }

        .progress {
            height: 5px;
        }
        
        .summary-window {
            position: fixed;
            right: 20px;
            top: 20px;
            width: 300px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        .summary-item {
            margin: 5px 0;
            display: flex;
            justify-content: space-between;
        }
        .summary-label {
            font-weight: bold;
        }
        .sequence-badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            margin-left: 5px;
        }
        .not-started { background: #f0f0f0; }
        .in-progress { background: #fff3cd; }
        .completed { background: #d4edda; }
        
        .status-container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .test-results {
            margin-top: 10px;
        }
        
        .test-result {
            margin-bottom: 5px;
        }
        
        .db-status {
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">App Monitor</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showSummaryPage()">Summary</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showSystemsPage()">Systems</a>
                    </li>
                </ul>
                <div class="d-flex">
                    <div class="btn-group">
                        <button type="button" class="btn btn-outline-light dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-file-import"></i> Import/Export
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li>
                                <label class="dropdown-item" style="cursor: pointer;">
                                    <i class="fas fa-file-upload"></i> Import CSV
                                    <input type="file" id="csvFileInput" accept=".csv" style="display: none;" onchange="handleFileSelect(this)">
                                </label>
                            </li>
                            <li><a class="dropdown-item" href="#" onclick="downloadExampleCSV()">
                                <i class="fas fa-file-download"></i> Export Systems
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="/api/csv/template">
                                <i class="fas fa-file-alt"></i> Download Template
                            </a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div id="systemsPage" class="container">
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped" id="systemsTable">
                        <thead>
                            <tr>
                                <th onclick="sortTable(0)" style="cursor: pointer;">Name <i class="fas fa-sort"></i></th>
                                <th onclick="sortTable(1)" style="cursor: pointer;">App Name <i class="fas fa-sort"></i></th>
                                <th onclick="sortTable(2)" style="cursor: pointer;">Target <i class="fas fa-sort"></i></th>
                                <th onclick="sortTable(3)" style="cursor: pointer;">DB Name <i class="fas fa-sort"></i></th>
                                <th onclick="sortTable(4)" style="cursor: pointer;">Status <i class="fas fa-sort"></i></th>
                                <th onclick="sortTable(5)" style="cursor: pointer;">Last Check <i class="fas fa-sort"></i></th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="systemsTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="summaryPage" class="container" style="display: none;">
        <h2>Systems Summary</h2>
        <div class="row">
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">System Status</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between mb-3">
                            <span>Total Systems:</span>
                            <span id="totalSystems" class="badge bg-secondary">0</span>
                        </div>
                        <div class="d-flex justify-content-between mb-3">
                            <span>Online:</span>
                            <span id="onlineSystems" class="badge bg-success">0</span>
                        </div>
                        <div class="d-flex justify-content-between mb-3">
                            <span>Offline:</span>
                            <span id="offlineSystems" class="badge bg-danger">0</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Database Status</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between mb-3">
                            <span>Total Databases:</span>
                            <span id="dbTotal" class="badge bg-secondary">0</span>
                        </div>
                        <div class="d-flex justify-content-between mb-3">
                            <span>DB Services Online:</span>
                            <span id="dbOnline" class="badge bg-success">0</span>
                        </div>
                        <div class="d-flex justify-content-between mb-3">
                            <span>DB Services Offline:</span>
                            <span id="dbOffline" class="badge bg-danger">0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Sequence Status</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between mb-3">
                            <span>Not Started:</span>
                            <span id="notStartedCount" class="badge bg-secondary">0</span>
                        </div>
                        <div class="d-flex justify-content-between mb-3">
                            <span>In Progress:</span>
                            <span id="inProgressCount" class="badge bg-warning">0</span>
                        </div>
                        <div class="d-flex justify-content-between mb-3">
                            <span>Completed:</span>
                            <span id="completedCount" class="badge bg-success">0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Recent Errors</h5>
                    </div>
                    <div class="card-body">
                        <ul class="list-group" id="recentErrors">
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <template id="systemCardTemplate">
        <div class="col">
            <div class="card h-100" data-system-id="">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0 system-name"></h5>
                    <span class="status-badge badge"></span>
                </div>
                <div class="card-body">
                    <p class="status-text mb-3"></p>
                    <div class="system-details">
                        <p class="mb-2"><strong>Application:</strong> <span class="app-name"></span></p>
                        <p class="mb-2"><strong>Target:</strong> <span class="target"></span></p>
                        <p class="mb-2"><strong>Check Type:</strong> <span class="check-type"></span></p>
                        <p class="mb-2"><strong>Database:</strong> <span class="database"></span></p>
                        <p class="mb-2"><strong>Owner:</strong> <span class="owner"></span></p>
                        <div class="cluster-nodes"></div>
                    </div>
                </div>
                <div class="card-footer text-end">
                    <div class="btn-group">
                        <button class="btn btn-sm btn-primary test-btn" onclick="">
                            <i class="fas fa-sync-alt loading-spinner" style="display: none;"></i>
                            Test Now
                        </button>
                        <button class="btn btn-sm btn-secondary edit-btn" onclick="">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger delete-btn" onclick="">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <!-- Edit Modal -->
    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit System</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editSystemForm" onsubmit="saveEditedSystem(event)">
                        <div class="mb-3">
                            <label class="form-label">System Name</label>
                            <input type="text" class="form-control" name="name" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Application Name</label>
                            <input type="text" class="form-control" name="app_name" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Check Type</label>
                            <select class="form-select" name="check_type" required>
                                <option value="http">HTTP</option>
                                <option value="ping">Ping</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Target URL/IP</label>
                            <input type="text" class="form-control" name="target">
                            <small class="text-muted">Required for single node systems. For clusters, first node will be used if empty.</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Cluster Nodes</label>
                            <input type="text" class="form-control" name="cluster_nodes">
                            <small class="text-muted">Comma-separated list of nodes</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Database Name</label>
                            <input type="text" class="form-control" name="db_name">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Database Type</label>
                            <input type="text" class="form-control" name="db_type">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Owner</label>
                            <input type="text" class="form-control" name="owner">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Shutdown Sequence</label>
                            <textarea class="form-control" name="shutdown_sequence" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" form="editSystemForm">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add System Wizard Modal -->
    <div class="modal fade" id="addSystemWizardModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New System</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="addSystemWizardForm" novalidate>
                    <div class="modal-body">
                        <!-- Progress Bar -->
                        <div class="progress mb-3">
                            <div class="progress-bar" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>

                        <!-- Step 1: Basic Information -->
                        <div class="wizard-step" data-step="1">
                            <h6 class="mb-3">Basic Information</h6>
                            <div class="mb-3">
                                <label class="form-label">System Name <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" name="name" required>
                                <div class="invalid-feedback">System name is required</div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Application Name <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" name="app_name" required>
                                <div class="invalid-feedback">Application name is required</div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Owner</label>
                                <input type="text" class="form-control" name="owner">
                            </div>
                        </div>

                        <!-- Step 2: Connection Details -->
                        <div class="wizard-step d-none" data-step="2">
                            <h6 class="mb-3">Connection Details</h6>
                            <div class="mb-3">
                                <label class="form-label">Check Type</label>
                                <select class="form-select" name="check_type">
                                    <option value="http">HTTP</option>
                                    <option value="ping">Ping</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Target URL/IP <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" name="target" required>
                                <div class="invalid-feedback">Target URL/IP is required</div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Cluster Nodes (comma-separated)</label>
                                <input type="text" class="form-control" name="cluster_nodes">
                                <div class="form-text">Leave empty for single-node systems</div>
                            </div>
                        </div>

                        <!-- Step 3: Additional Details -->
                        <div class="wizard-step d-none" data-step="3">
                            <h6 class="mb-3">Additional Details</h6>
                            
                            <!-- Database Section -->
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="hasDatabase" onchange="toggleDatabaseFields()">
                                    <label class="form-check-label" for="hasDatabase">
                                        This system has a database
                                    </label>
                                </div>
                            </div>
                            
                            <div id="databaseFields" class="d-none">
                                <div class="mb-3">
                                    <label class="form-label">Database Type</label>
                                    <select class="form-select" name="db_type" id="dbType">
                                        <option value="">Select Database Type</option>
                                        <option value="mysql">MySQL</option>
                                        <option value="postgres">PostgreSQL</option>
                                        <option value="mongodb">MongoDB</option>
                                        <option value="oracle">Oracle</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Database Name</label>
                                    <input type="text" class="form-control" name="db_name" id="dbName">
                                </div>
                            </div>

                            <!-- Shutdown Sequence Section -->
                            <div class="mb-3">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="hasShutdownSequence" onchange="toggleShutdownSequence()">
                                    <label class="form-check-label" for="hasShutdownSequence">
                                        Add shutdown sequence
                                    </label>
                                </div>
                                <div id="shutdownSequenceSection" class="d-none">
                                    <div id="shutdownStepsContainer">
                                        <div class="input-group mb-2">
                                            <span class="input-group-text">Step 1</span>
                                            <input type="text" class="form-control shutdown-step-input" 
                                                   placeholder="e.g., service nginx stop"
                                                   oninput="updateShutdownSequence()">
                                            <button class="btn btn-outline-secondary" type="button" onclick="addShutdownStep()">
                                                <i class="bi bi-plus"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <input type="hidden" name="shutdown_sequence" id="shutdownSequenceValue">
                                    <div class="form-text">Enter shutdown commands in the order they should be executed</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-secondary prev-btn" onclick="previousStep()">Previous</button>
                        <button type="button" class="btn btn-primary next-btn" onclick="nextStep()">Next</button>
                        <button type="button" class="btn btn-success submit-btn d-none" onclick="submitWizard()">Submit</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- CSV Mapping Modal -->
    <div class="modal fade" id="csvMappingModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">CSV Import</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        Please map your CSV columns to the corresponding system fields. Leave unmapped fields as "None".
                    </div>
                    <div id="csvPreviewContainer">
                        <h6>CSV Preview</h6>
                        <div class="table-responsive">
                            <table class="table table-sm" id="csvPreviewTable">
                                <thead>
                                    <tr id="csvHeaderRow"></tr>
                                </thead>
                                <tbody id="csvPreviewBody"></tbody>
                            </table>
                        </div>
                    </div>
                    <div id="columnMappingContainer" class="mt-3">
                        <h6>Column Mapping</h6>
                        <div id="mappingFields">
                            <!-- Mapping fields will be added here dynamically -->
                        </div>
                    </div>
                    <div id="importWarnings" class="alert alert-warning mt-3" style="display: none;">
                        <!-- Import warnings will be shown here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="importMappedCSV()">Import</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Import Warning Modal -->
    <div class="modal fade" id="importWarningModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Import Warnings</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning">
                        The following issues were found in your CSV file:
                    </div>
                    <ul id="warningsList" class="list-unstyled">
                        <!-- Warnings will be added here -->
                    </ul>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="proceedWithImport()">Proceed Anyway</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container"></div>

    <button id="refreshButton" class="btn btn-sm btn-success" style="margin-left: 10px;" title="Test all systems" aria-label="Trigger test for all systems">
        <i class="fas fa-sync-alt"></i> Trigger All Tests
    </button>

    <div class="mb-3">
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addSystemWizardModal">
            <i class="fas fa-plus"></i> Add System
        </button>
        <button id="refreshButton" class="btn btn-secondary">
            <i class="fas fa-sync"></i> Refresh All
        </button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let systems = [];
        let currentStep = 1;
        const totalSteps = 3;

        // Fetch systems from the server
        function fetchSystems() {
            fetch('/api/systems')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    systems = data.systems || [];
                    updateSystemsTable();
                    updateSummary();
                })
                .catch(error => {
                    showToast('Error fetching systems: ' + error.message, 'error');
                });
        }

        // Update the systems table display
        function updateSystemsTable() {
            const tbody = document.getElementById('systemsTableBody');
            tbody.innerHTML = '';

            if (!systems || systems.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center">No systems found</td>
                    </tr>
                `;
                return;
            }

            systems.forEach(system => {
                const row = createSystemRow(system);
                tbody.appendChild(row);
            });

            // Initialize tooltips
            const tooltips = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltips.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        }

        // Create a row for a system
        function createSystemRow(system) {
            const row = document.createElement('tr');
            const systemId = system._id.$oid || system._id;
            const lastCheck = system.last_check ? new Date(system.last_check).toLocaleString() : 'Never';
            
            row.innerHTML = `
                <td>${system.name || 'Unknown'}</td>
                <td>${system.app_name || 'N/A'}</td>
                <td>
                    ${system.target || 'N/A'}
                    ${system.cluster_nodes ? `
                        <div class="cluster-nodes">
                            ${Array.isArray(system.cluster_nodes) ? 
                                system.cluster_nodes.map(node => {
                                    const nodeHost = typeof node === 'string' ? node : node.host;
                                    const nodeStatus = typeof node === 'string' ? false : node.status;
                                    return `
                                        <span class="cluster-node ${nodeStatus ? 'bg-success text-white' : 'bg-danger text-white'}">
                                            ${nodeHost}
                                        </span>
                                    `;
                                }).join('') 
                                : ''
                            }
                        </div>
                    ` : ''}
                </td>
                <td>${system.db_name || 'N/A'}</td>
                <td>
                    <span class="status-badge ${system.status ? 'online' : 'offline'}"
                          data-bs-toggle="tooltip" 
                          title="${system.last_error || (system.status ? 'System is online' : 'System is offline')}">
                        ${system.status ? 'Online' : 'Offline'}
                    </span>
                    ${system.last_error ? `
                        <div class="error-message mt-1">
                            <small>${system.last_error}</small>
                        </div>
                    ` : ''}
                </td>
                <td>${lastCheck}</td>
                <td>
                    <div class="btn-group btn-group-sm" role="group">
                        <button class="btn btn-success" onclick="checkSystem('${systemId}')"
                                data-bs-toggle="tooltip" title="Test system connectivity and services">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                        <button class="btn btn-info" onclick="editSystem('${systemId}')"
                                data-bs-toggle="tooltip" title="Edit system configuration">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger" onclick="deleteSystem('${systemId}')"
                                data-bs-toggle="tooltip" title="Delete this system">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            `;

            // Initialize tooltips for the new row
            row.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => {
                new bootstrap.Tooltip(el);
            });

            return row;
        }

        // Add sorting function
        let sortDirection = 1;
        let lastSortedColumn = -1;

        function sortTable(column) {
            const table = document.getElementById('systemsTable');
            const tbody = table.getElementsByTagName('tbody')[0];
            const rows = Array.from(tbody.getElementsByTagName('tr'));
            
            // Update sort direction
            if (lastSortedColumn === column) {
                sortDirection *= -1;
            } else {
                sortDirection = 1;
            }
            lastSortedColumn = column;
            
            // Update sort icons
            const headers = table.getElementsByTagName('th');
            for (let i = 0; i < headers.length; i++) {
                const icon = headers[i].getElementsByTagName('i')[0];
                if (i === column) {
                    icon.className = sortDirection === 1 ? 'fas fa-sort-up' : 'fas fa-sort-down';
                } else {
                    icon.className = 'fas fa-sort';
                }
            }
            
            // Sort rows
            rows.sort((a, b) => {
                let aValue = a.cells[column].textContent.trim();
                let bValue = b.cells[column].textContent.trim();
                
                // Handle status column specially
                if (column === 4) { // Status column
                    aValue = a.cells[column].querySelector('.status-badge').classList.contains('online');
                    bValue = b.cells[column].querySelector('.status-badge').classList.contains('online');
                }
                
                if (aValue < bValue) return -1 * sortDirection;
                if (aValue > bValue) return 1 * sortDirection;
                return 0;
            });
            
            // Reorder rows
            rows.forEach(row => tbody.appendChild(row));
        }

        // Update test results display
        function editSystem(systemId) {
            const system = systems.find(s => (s._id.$oid || s._id) === systemId);
            if (!system) {
                showToast('System not found', 'error');
                return;
            }

            const form = document.getElementById('editSystemForm');
            form.dataset.systemId = systemId;
            
            // Set form values with null checks
            const fields = {
                'name': system.name,
                'app_name': system.app_name,
                'check_type': system.check_type,
                'target': system.target,
                'db_name': system.db_name,
                'db_type': system.db_type,
                'owner': system.owner,
                'shutdown_sequence': system.shutdown_sequence,
                'cluster_nodes': system.cluster_nodes ? system.cluster_nodes.join(',') : ''
            };

            for (const [field, value] of Object.entries(fields)) {
                const element = form.querySelector(`[name="${field}"]`);
                if (element) {
                    element.value = value || '';
                }
            }

            // Show the modal
            new bootstrap.Modal(document.getElementById('editModal')).show();
        }

        // Save edited system
        function saveEditedSystem(event) {
            event.preventDefault();
            const form = document.getElementById('editSystemForm');
            const systemId = form.dataset.systemId;
            
            if (!systemId) {
                showToast('System ID not found', 'error');
                return;
            }

            const formData = {
                name: form.querySelector('[name="name"]').value.trim(),
                app_name: form.querySelector('[name="app_name"]').value.trim(),
                check_type: form.querySelector('[name="check_type"]').value,
                target: form.querySelector('[name="target"]').value.trim(),
                db_name: form.querySelector('[name="db_name"]').value.trim(),
                db_type: form.querySelector('[name="db_type"]').value.trim(),
                owner: form.querySelector('[name="owner"]').value.trim(),
                shutdown_sequence: form.querySelector('[name="shutdown_sequence"]').value.trim(),
                cluster_nodes: form.querySelector('[name="cluster_nodes"]').value.trim()
            };

            if (!formData.name || !formData.app_name) {
                showToast('System Name and Application Name are required', 'error');
                return;
            }

            fetch(`/api/systems/${systemId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showToast(data.error, 'error');
                } else {
                    showToast('System updated successfully', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
                    fetchSystems();
                }
            })
            .catch(error => {
                showToast('Error updating system: ' + error.message, 'error');
            });
        }

        // Delete system
        function deleteSystem(systemId) {
            if (!confirm('Are you sure you want to delete this system?')) {
                return;
            }

            fetch(`/api/systems/${systemId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showToast(data.error, 'error');
                } else {
                    showToast('System deleted successfully', 'success');
                    fetchSystems();
                }
            })
            .catch(error => {
                showToast('Error deleting system: ' + error.message, 'error');
            });
        }

        // Import CSV
        function handleFileSelect(input) {
            if (!input.files || !input.files[0]) {
                showToast('Please select a file', 'error');
                return;
            }

            const file = input.files[0];
            if (file.type !== 'text/csv' && !file.name.endsWith('.csv')) {
                showToast('Please select a CSV file', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                previewCSV(text);
            };
            reader.onerror = function() {
                showToast('Error reading file', 'error');
            };
            reader.readAsText(file, 'UTF-8');
        }

        // Preview CSV content
        function previewCSV(content) {
            try {
                const lines = content.split('\n');
                if (lines.length < 2) {
                    showToast('CSV file must contain headers and at least one data row', 'error');
                    return;
                }

                // Parse headers (first line)
                const headers = lines[0].split(',').map(h => h.trim());
                
                // Parse preview rows (up to 5 rows)
                const previewRows = lines.slice(1, 6).map(line => 
                    line.split(',').map(cell => cell.trim())
                );

                // Update preview table
                document.getElementById('csvHeaderRow').innerHTML = headers.map(h => 
                    `<th>${h}</th>`
                ).join('');

                document.getElementById('csvPreviewBody').innerHTML = previewRows.map(row =>
                    `<tr>${row.map(cell => `<td>${cell}</td>`).join('')}</tr>`
                ).join('');

                // Set up field mapping
                setupFieldMapping(headers);

                // Show the mapping modal
                const modal = new bootstrap.Modal(document.getElementById('csvMappingModal'));
                modal.show();
            } catch (error) {
                console.error('Error previewing CSV:', error);
                showToast('Error previewing CSV file', 'error');
            }
        }

        // Set up field mapping interface
        function setupFieldMapping(headers) {
            const mappingFields = document.getElementById('mappingFields');
            mappingFields.innerHTML = '';

            const systemFields = [
                { id: 'name', label: 'System Name', required: true },
                { id: 'app_name', label: 'Application Name' },
                { id: 'check_type', label: 'Check Type' },
                { id: 'target', label: 'Target URL/IP', required: true },
                { id: 'db_name', label: 'Database Name' },
                { id: 'db_type', label: 'Database Type' },
                { id: 'db_port', label: 'Database Port' },
                { id: 'owner', label: 'Owner' },
                { id: 'mount_points', label: 'Mount Points' },
                { id: 'shutdown_sequence', label: 'Shutdown Sequence' },
                { id: 'cluster_nodes', label: 'Cluster Nodes' }
            ];

            systemFields.forEach(field => {
                const div = document.createElement('div');
                div.className = 'mb-3';
                div.innerHTML = `
                    <label class="form-label">
                        ${field.label} ${field.required ? '<span class="text-danger">*</span>' : ''}
                    </label>
                    <select class="form-select" data-field="${field.id}" ${field.required ? 'required' : ''}>
                        <option value="">None</option>
                        ${headers.map(h => `<option value="${h}">${h}</option>`).join('')}
                    </select>
                `;
                mappingFields.appendChild(div);
            });
        }

        // Import mapped CSV
        function importMappedCSV() {
            const mapping = {};
            const selects = document.querySelectorAll('#mappingFields select');
            
            selects.forEach(select => {
                if (select.value) {
                    mapping[select.dataset.field] = select.value;
                }
            });

            // Check required fields
            const requiredFields = ['name', 'target'];
            const missingFields = requiredFields.filter(field => !mapping[field]);
            
            if (missingFields.length > 0) {
                showToast(`Missing required fields: ${missingFields.join(', ')}`, 'error');
                return;
            }

            const fileInput = document.getElementById('csvFileInput');
            if (!fileInput.files || !fileInput.files[0]) {
                showToast('No file selected', 'error');
                return;
            }

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('mapping', JSON.stringify(mapping));

            fetch('/api/systems/import', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // Handle warnings if present
                if (data.warnings && data.warnings.length > 0) {
                    showImportWarnings(data.warnings);
                    return;
                }

                // Close modal and show success message
                bootstrap.Modal.getInstance(document.getElementById('csvMappingModal')).hide();
                showToast(data.message, 'success');
                fetchSystems();
            })
            .catch(error => {
                console.error('Import error:', error);
                showToast('Error importing systems: ' + error.message, 'error');
            });
        }

        // Wizard navigation functions
        function nextStep() {
            if (currentStep < totalSteps) {
                const currentStepElement = document.querySelector(`.wizard-step[data-step="${currentStep}"]`);
                const form = document.getElementById('addSystemWizardForm');
                
                // Validate current step
                const inputs = currentStepElement.querySelectorAll('input[required], select[required]');
                let isValid = true;
                
                inputs.forEach(input => {
                    if (!input.value.trim()) {
                        input.classList.add('is-invalid');
                        isValid = false;
                    } else {
                        input.classList.remove('is-invalid');
                    }
                });
                
                if (!isValid) {
                    return;
                }
                
                currentStep++;
                showStep(currentStep);
            }
        }

        function previousStep() {
            if (currentStep > 1) {
                currentStep--;
                showStep(currentStep);
            }
        }

        function showStep(step) {
            // Hide all steps
            document.querySelectorAll('.wizard-step').forEach(stepElement => {
                stepElement.classList.add('d-none');
            });
            
            // Show current step
            const currentStepElement = document.querySelector(`.wizard-step[data-step="${step}"]`);
            if (currentStepElement) {
                currentStepElement.classList.remove('d-none');
            }
            
            // Update buttons
            const prevBtn = document.querySelector('.prev-btn');
            const nextBtn = document.querySelector('.next-btn');
            const submitBtn = document.querySelector('.submit-btn');
            
            if (prevBtn) {
                prevBtn.style.display = step === 1 ? 'none' : 'inline-block';
            }
            
            if (nextBtn && submitBtn) {
                if (step === totalSteps) {
                    nextBtn.classList.add('d-none');
                    submitBtn.classList.remove('d-none');
                } else {
                    nextBtn.classList.remove('d-none');
                    submitBtn.classList.add('d-none');
                }
            }
            
            // Update progress bar
            updateProgressBar(step);
        }

        function updateProgressBar(step) {
            const progress = ((step - 1) / (totalSteps - 1)) * 100;
            const progressBar = document.querySelector('.progress-bar');
            if (progressBar) {
                progressBar.style.width = `${progress}%`;
                progressBar.setAttribute('aria-valuenow', progress);
            }
        }

        // Shutdown sequence handling
        function addShutdownStep() {
            const container = document.getElementById('shutdownStepsContainer');
            const stepNumber = container.children.length + 1;
            const newGroup = document.createElement('div');
            newGroup.className = 'input-group mb-2';
            newGroup.innerHTML = `
                <span class="input-group-text">Step ${stepNumber}</span>
                <input type="text" class="form-control shutdown-step-input" 
                       placeholder="e.g., service nginx stop"
                       oninput="updateShutdownSequence()">
                <button class="btn btn-outline-danger" type="button" onclick="removeShutdownStep(this)">
                    <i class="bi bi-trash"></i>
                </button>
            `;
            container.appendChild(newGroup);
        }

        function removeShutdownStep(button) {
            button.closest('.input-group').remove();
            // Renumber remaining steps
            const container = document.getElementById('shutdownStepsContainer');
            container.querySelectorAll('.input-group-text').forEach((span, index) => {
                span.textContent = `Step ${index + 1}`;
            });
            updateShutdownSequence();
        }

        function updateShutdownSequence() {
            const inputs = document.querySelectorAll('.shutdown-step-input');
            const steps = Array.from(inputs)
                .map(input => input.value.trim())
                .filter(step => step);
            document.getElementById('shutdownSequenceValue').value = steps.length > 0 ? steps.join(';') : '';
        }

        // Toggle functions for optional sections
        function toggleDatabaseFields() {
            const hasDatabase = document.getElementById('hasDatabase').checked;
            const databaseFields = document.getElementById('databaseFields');
            databaseFields.classList.toggle('d-none', !hasDatabase);
            
            if (!hasDatabase) {
                document.getElementById('dbType').value = '';
                document.getElementById('dbName').value = '';
            }
        }

        function toggleShutdownSequence() {
            const hasShutdownSequence = document.getElementById('hasShutdownSequence').checked;
            const shutdownSequenceSection = document.getElementById('shutdownSequenceSection');
            shutdownSequenceSection.classList.toggle('d-none', !hasShutdownSequence);
            
            if (!hasShutdownSequence) {
                document.getElementById('shutdownSequenceValue').value = '';
                document.getElementById('shutdownStepsContainer').innerHTML = `
                    <div class="input-group mb-2">
                        <span class="input-group-text">Step 1</span>
                        <input type="text" class="form-control shutdown-step-input" 
                               placeholder="e.g., service nginx stop"
                               oninput="updateShutdownSequence()">
                        <button class="btn btn-outline-secondary" type="button" onclick="addShutdownStep()">
                            <i class="bi bi-plus"></i>
                        </button>
                    </div>
                `;
            }
        }

        // Modified submitWizard function
        function submitWizard() {
            const form = document.getElementById('addSystemWizardForm');
            if (!form) {
                showToast('Form not found', 'error');
                return;
            }

            // Validate required fields
            const inputs = form.querySelectorAll('input[required], select[required]');
            let isValid = true;
            
            inputs.forEach(input => {
                if (!input.value.trim()) {
                    input.classList.add('is-invalid');
                    isValid = false;
                } else {
                    input.classList.remove('is-invalid');
                }
            });
            
            if (!isValid) {
                showToast('Please fill in all required fields', 'error');
                return;
            }

            // Get form data
            const formData = new FormData(form);
            const system = Object.fromEntries(formData.entries());

            // Set default values for optional fields
            system.app_name = system.app_name?.trim() || 'N/A';
            system.owner = system.owner?.trim() || 'N/A';

            // Handle database fields
            if (!document.getElementById('hasDatabase').checked) {
                system.db_type = 'N/A';
                system.db_name = 'N/A';
            } else {
                system.db_type = system.db_type?.trim() || 'N/A';
                system.db_name = system.db_name?.trim() || 'N/A';
            }

            // Handle shutdown sequence
            if (!document.getElementById('hasShutdownSequence').checked) {
                system.shutdown_sequence = 'N/A';
            } else {
                const shutdownInputs = document.querySelectorAll('.shutdown-step-input');
                const steps = Array.from(shutdownInputs)
                    .map(input => input.value.trim())
                    .filter(step => step);
                system.shutdown_sequence = steps.length > 0 ? steps.join(';') : 'N/A';
            }

            // Handle cluster nodes
            if (system.cluster_nodes) {
                const nodes = system.cluster_nodes.split(';')
                    .map(node => node.trim())
                    .filter(node => node);
                system.cluster_nodes = nodes.length > 0 ? nodes : null;
            } else {
                system.cluster_nodes = null;
            }

            // Set default check type
            system.check_type = system.check_type || 'ping';

            // Validate target
            if (!system.target?.trim() && !system.cluster_nodes) {
                showToast('Target URL/IP is required for non-cluster systems', 'error');
                return;
            }

            // Add system
            fetch('/api/systems', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(system)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showToast(data.error, 'error');
                } else {
                    showToast('System added successfully', 'success');
                    form.reset();
                    bootstrap.Modal.getInstance(document.getElementById('addSystemWizardModal')).hide();
                    fetchSystems();
                }
            })
            .catch(error => {
                showToast('Error adding system: ' + error.message, 'error');
            });
        }

        // Reset wizard when modal is closed
        document.getElementById('addSystemWizardModal').addEventListener('hidden.bs.modal', function () {
            currentStep = 1;
            showStep(1);
            const form = document.getElementById('addSystemWizardForm');
            if (form) {
                form.reset();
                
                // Reset all toggleable sections
                document.getElementById('hasDatabase').checked = false;
                document.getElementById('hasShutdownSequence').checked = false;
                
                toggleDatabaseFields();
                toggleShutdownSequence();
            }
            // Reset validation state
            form.querySelectorAll('.is-invalid, .is-valid').forEach(input => {
                input.classList.remove('is-invalid', 'is-valid');
            });
        });

        // CSV download function
        function downloadExampleCSV() {
            fetch('/api/download/example-csv')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.blob();
                })
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'example_systems.csv';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    a.remove();
                })
                .catch(error => {
                    showToast('Error downloading example file: ' + error.message, 'error');
                });
        }

        // Toast notification system
        function showToast(message, type = 'success', duration = 5000) {
            const toastContainer = document.getElementById('toastContainer');
            if (!toastContainer) {
                // Create toast container if it doesn't exist
                const container = document.createElement('div');
                container.id = 'toastContainer';
                container.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 1050;';
                document.body.appendChild(container);
            }

            const toast = document.createElement('div');
            toast.className = `toast align-items-center border-0 ${type === 'error' ? 'bg-danger' : 'bg-success'} text-white`;
            toast.setAttribute('role', 'alert');
            toast.setAttribute('aria-live', 'assertive');
            toast.setAttribute('aria-atomic', 'true');

            const toastContent = document.createElement('div');
            toastContent.className = 'd-flex';

            const messageDiv = document.createElement('div');
            messageDiv.className = 'toast-body';
            messageDiv.innerHTML = message;

            const closeButton = document.createElement('button');
            closeButton.type = 'button';
            closeButton.className = 'btn-close btn-close-white me-2 m-auto';
            closeButton.setAttribute('data-bs-dismiss', 'toast');
            closeButton.setAttribute('aria-label', 'Close');

            toastContent.appendChild(messageDiv);
            toastContent.appendChild(closeButton);
            toast.appendChild(toastContent);
            toastContainer.appendChild(toast);

            const bsToast = new bootstrap.Toast(toast, { autohide: true, delay: duration });
            bsToast.show();

            // Remove toast after it's hidden
            toast.addEventListener('hidden.bs.toast', () => {
                toast.remove();
            });
        }

        function updateSystemStatus(systemId, status) {
            const systemCard = document.querySelector(`[data-system-id="${systemId}"]`);
            if (!systemCard) return;

            const statusBadge = systemCard.querySelector('.status-badge');
            const statusText = systemCard.querySelector('.status-text');
            const loadingSpinner = systemCard.querySelector('.loading-spinner');
            const testBtn = systemCard.querySelector('.test-btn');
            
            // Remove loading state
            if (loadingSpinner) {
                loadingSpinner.style.display = 'none';
            }
            
            // Update button text
            if (testBtn) {
                testBtn.innerHTML = `
                    <i class="fas fa-sync-alt loading-spinner" style="display: none;"></i>
                    Test Now
                `;
            }

            if (statusBadge) {
                statusBadge.className = `status-badge badge ${status ? 'bg-success' : 'bg-danger'}`;
                statusBadge.textContent = status ? 'Online' : 'Offline';
            }

            if (statusText) {
                const systemName = systemCard.querySelector('.system-name')?.textContent || 'System';
                statusText.textContent = `${systemName} is ${status ? 'online' : 'offline'}`;
            }
        }

        function testSystem(systemId) {
            const systemCard = document.querySelector(`[data-system-id="${systemId}"]`);
            if (!systemCard) return;

            // Show loading spinner and update button text
            const testBtn = systemCard.querySelector('.test-btn');
            const loadingSpinner = systemCard.querySelector('.loading-spinner');
            
            if (testBtn && loadingSpinner) {
                loadingSpinner.style.display = 'inline-block';
                testBtn.innerHTML = `
                    <i class="fas fa-sync-alt loading-spinner" style="display: inline-block;"></i>
                    Testing...
                `;
            }

            fetch(`/api/systems/${systemId}/test`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                updateSystemStatus(systemId, data.status);
                
                // Show any errors in the toast
                if (data.errors && Object.keys(data.errors).length > 0) {
                    let errorMessage = '<ul class="list-unstyled mb-0">';
                    for (const [type, error] of Object.entries(data.errors)) {
                        errorMessage += `<li><strong>${type}:</strong> ${error}</li>`;
                    }
                    errorMessage += '</ul>';
                    showToast(errorMessage, 'error');
                }
            })
            .catch(error => {
                console.error('Error testing system:', error);
                showToast('Error testing system: ' + error.message, 'error');
                // Reset loading state
                updateSystemStatus(systemId, false);
            });
        }

        function fetchSystems() {
            const systemsContainer = document.getElementById('systemsContainer');
            if (!systemsContainer) return;

            // Clear existing content
            systemsContainer.innerHTML = '';
            
            fetch('/api/systems')
                .then(response => response.json())
                .then(systems => {
                    if (systems.length === 0) {
                        systemsContainer.innerHTML = `
                            <div class="col-12 text-center">
                                <p class="text-muted">No systems found. Add a system to get started.</p>
                            </div>
                        `;
                        return;
                    }

                    // Create and append system cards
                    systems.forEach(system => {
                        const card = createSystemCard(system);
                        systemsContainer.appendChild(card);
                    });
                })
                .catch(error => {
                    console.error('Error fetching systems:', error);
                    showToast('Error fetching systems: ' + error.message, 'error');
                });
        }

        function createSystemCard(system) {
            const template = document.getElementById('systemCardTemplate');
            const clone = document.importNode(template.content, true);
            
            // Set system ID and data attributes
            const card = clone.querySelector('.card');
            card.setAttribute('data-system-id', system._id);
            
            // Set system name and status
            const systemName = clone.querySelector('.system-name');
            systemName.textContent = system.name || 'Unnamed System';
            
            const statusBadge = clone.querySelector('.status-badge');
            statusBadge.className = `status-badge badge ${system.status ? 'bg-success' : 'bg-danger'}`;
            statusBadge.textContent = system.status ? 'Online' : 'Offline';
            
            const statusText = clone.querySelector('.status-text');
            statusText.textContent = `${system.name || 'System'} is ${system.status ? 'online' : 'offline'}`;
            
            // Set system details
            clone.querySelector('.app-name').textContent = system.app_name || 'N/A';
            clone.querySelector('.target').textContent = system.target || 'N/A';
            clone.querySelector('.check-type').textContent = system.check_type || 'ping';
            clone.querySelector('.database').textContent = system.db_type !== 'N/A' ? 
                `${system.db_type} (${system.db_name})` : 'N/A';
            clone.querySelector('.owner').textContent = system.owner || 'N/A';
            
            // Set up cluster nodes if present
            const clusterNodesDiv = clone.querySelector('.cluster-nodes');
            if (system.cluster_nodes && system.cluster_nodes.length > 0) {
                const nodesHtml = `
                    <p class="mb-2"><strong>Cluster Nodes:</strong></p>
                    <ul class="list-unstyled">
                        ${system.cluster_nodes.map(node => `
                            <li>
                                <i class="fas fa-server me-2"></i>
                                ${node.host}
                                <span class="badge ${node.status ? 'bg-success' : 'bg-danger'} ms-2">
                                    ${node.status ? 'Online' : 'Offline'}
                                </span>
                            </li>
                        `).join('')}
                    </ul>
                `;
                clusterNodesDiv.innerHTML = nodesHtml;
            }
            
            // Set up button handlers
            const testBtn = clone.querySelector('.test-btn');
            testBtn.innerHTML = `
                <i class="fas fa-sync-alt loading-spinner" style="display: none;"></i>
                Test Now
            `;
            testBtn.onclick = () => testSystem(system._id);
            
            const editBtn = clone.querySelector('.edit-btn');
            editBtn.onclick = () => editSystem(system._id);
            
            const deleteBtn = clone.querySelector('.delete-btn');
            deleteBtn.onclick = () => deleteSystem(system._id);
            
            return clone;
        }

        // Add refresh button click handler
        document.getElementById('refreshButton').addEventListener('click', function() {
            showToast('Checking all systems...', 'info');
            fetch('/api/systems/check_all')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    fetchSystems();  // Refresh the systems table
                    updateSummary(); // Refresh the summary
                    showToast('All systems checked successfully', 'success');
                })
                .catch(error => {
                    console.error('Error checking systems:', error);
                    showToast('Error checking systems: ' + error.message, 'error');
                });
        });

        // Add check system function
        function checkSystem(systemId) {
            fetch(`/api/systems/check/${systemId}`)
                .then(response => response.json())
                .then(result => {
                    if (result.error) {
                        const message = `Check failed for ${result.target}: ${result.error}`;
                        showToast(message, 'error');
                    } else {
                        const message = result.status ? 
                            `${result.target} is online` : 
                            `${result.target} is offline${result.error ? ': ' + result.error : ''}`;
                        showToast(message, result.status ? 'success' : 'warning');
                    }
                    fetchSystems(); // Refresh the table
                })
                .catch(error => {
                    showToast('Error checking system: ' + error.message, 'error');
                });
        }

        // Update summary
        function updateSummary() {
            fetch('/api/systems/summary')
                .then(response => response.json())
                .then(data => {
                    // Update system counts
                    document.getElementById('totalSystems').textContent = data.total_systems;
                    document.getElementById('onlineSystems').textContent = data.online_systems;
                    document.getElementById('offlineSystems').textContent = data.offline_systems;
                    
                    // Update database counts
                    document.getElementById('dbTotal').textContent = data.db_total;
                    document.getElementById('dbOnline').textContent = data.db_online;
                    document.getElementById('dbOffline').textContent = data.db_offline;
                    
                    // Update sequence status
                    document.getElementById('notStartedCount').textContent = data.sequence_status.not_started;
                    document.getElementById('inProgressCount').textContent = data.sequence_status.in_progress;
                    document.getElementById('completedCount').textContent = data.sequence_status.completed;
                    
                    // Update recent errors
                    const recentErrorsList = document.getElementById('recentErrors');
                    recentErrorsList.innerHTML = '';
                    
                    if (data.recent_errors && data.recent_errors.length > 0) {
                        data.recent_errors.forEach(error => {
                            const li = document.createElement('li');
                            li.className = 'list-group-item';
                            li.innerHTML = `
                                <strong>${error.system_name}</strong>: ${error.error}
                                ${error.timestamp ? `<br><small class="text-muted">at ${new Date(error.timestamp).toLocaleString()}</small>` : ''}
                            `;
                            recentErrorsList.appendChild(li);
                        });
                    } else {
                        recentErrorsList.innerHTML = '<li class="list-group-item">No recent errors</li>';
                    }
                })
                .catch(error => {
                    console.error('Error updating summary:', error);
                    showToast('Error updating summary: ' + error.message, 'error');
                });
        }

        // Initialize page
        fetchSystems();
        updateSummary();
        
        // Update summary every 30 seconds
        setInterval(() => {
            fetchSystems();
            updateSummary();
        }, 30000);
    </script>
</body>
</html>
